{% extends "base.html" %}
{% block content %}

<div class="container-fluid">

  <!-- Filters + Export (unchanged) -->
  <div class="row g-4 mb-4">
    <!-- Filters -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-filter me-2"></i> Report Filters</h5>
        </div>
        <div class="card-body">
          <form method="GET" action="/reports">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="dateFrom" class="form-label">From Date</label>
                <input type="date" class="form-control" id="dateFrom" name="date_from"
                       value="{{ request.args.get('date_from','') }}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="dateTo" class="form-label">To Date</label>
                <input type="date" class="form-control" id="dateTo" name="date_to"
                       value="{{ request.args.get('date_to','') }}">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter" name="status">
                  <option value="">All Statuses</option>
                  <option value="Active" {% if request.args.get('status')=='Active' %}selected{% endif %}>Active</option>
                  <option value="Failed" {% if request.args.get('status')=='Failed' %}selected{% endif %}>Failed</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="vendorFilter" class="form-label">Vendor</label>
                <select class="form-select" id="vendorFilter" name="vendor">
                  <option value="">All Vendors</option>
                  {% for v in vendors %}
                    <option value="{{ v }}" {% if request.args.get('vendor')==v %}selected{% endif %}>{{ v }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <button class="btn btn-primary w-100 mt-2" type="submit">
              <i class="fas fa-search"></i> Apply Filters
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Export Options -->
    <div class="col-md-6">
      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-download me-2"></i> Export Options</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Export current report data:</p>
          <div class="d-grid gap-2">
            <a href="/export/excel" class="btn btn-outline-success">
              <i class="fas fa-file-excel"></i> Excel
            </a>
            <a href="/export/pdf" class="btn btn-outline-danger">
              <i class="fas fa-file-pdf"></i> PDF
            </a>
            <a href="/export/csv" class="btn btn-outline-info">
              <i class="fas fa-file-csv"></i> CSV
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart & Table Switch -->
  <div class="card shadow-sm border-0 rounded-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><i class="fas fa-chart-bar me-2"></i> Data Visualization</span>
      <select id="dataView" class="form-select w-auto">
        <option value="none" selected>Select View</option>
        <option value="bar">Bar Chart</option>
        <option value="pie">Pie Chart</option>
        <option value="line">Line Chart</option>
      </select>
    </div>
    <div class="card-body">
      <div id="chartContainer" style="display:none;">
        <canvas id="reportChart" height="120"></canvas>
      </div>
    </div>
  </div>

  <!-- Raw Data Accordion -->
  <div class="accordion mt-4" id="itemDataAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingItems">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseItems" aria-expanded="false" aria-controls="collapseItems">
          <i class="fas fa-table me-2"></i> Show Item Data
        </button>
      </h2>
      <div id="collapseItems" class="accordion-collapse collapse" aria-labelledby="headingItems"
           data-bs-parent="#itemDataAccordion">
        <div class="accordion-body">
          {% if reports %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Item ID</th>
                    <th>Item Type</th>
                    <th>Vendor</th>
                    <th>Lot Number</th>
                    <th>Date of Supply</th>
                    <th>Inspection Date</th>
                    <th>Warranty Period</th>
                    <th>Status</th>
                    <th>Failure Date</th>
                    <th>Location</th>
                    <th>Performance Score</th>
                  </tr>
                </thead>
                <tbody id="reportTableBody">
                  {% for r in reports[:200] %}
                  <tr>
                    <td>{{ r.Item_ID }}</td>
                    <td>{{ r.Item_Type }}</td>
                    <td>{{ r.Vendor_Name }}</td>
                    <td>{{ r.Lot_Number }}</td>
                    <td>{{ r.Date_of_Supply }}</td>
                    <td>{{ r.Inspection_Date }}</td>
                    <td>{{ r.Warranty_Period }}</td>
                    <td>{{ r.Status }}</td>
                    <td>{{ r.Failure_Date }}</td>
                    <td>{{ r.Location }}</td>
                    <td>{{ r.Performance_Score }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% if reports|length > 200 %}
              <div class="text-center mt-3">
                <button id="loadMoreBtn" class="btn btn-outline-primary">Show More Data</button>
              </div>
            {% endif %}
          {% else %}
            <div class="alert alert-info mb-0">
              <i class="fas fa-info-circle"></i> No report data available.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let offset = 200;
const totalReports = {{ reports|length }};
const loadBtn = document.getElementById("loadMoreBtn");

function renderChart(type) {
  const chartContainer = document.getElementById("chartContainer");
  if (type === "none") {
    chartContainer.style.display = "none";
    if (window.currentChart) window.currentChart.destroy();
    return;
  }
  chartContainer.style.display = "block";
  const ctx = document.getElementById("reportChart").getContext("2d");
  if (window.currentChart) window.currentChart.destroy();
  window.currentChart = new Chart(ctx, {
    type: type,
    data: {
      labels: [{% for r in reports[:200] %}"{{ r.Item_Type }}",{% endfor %}],
      datasets: [{
        label: "Performance Score",
        data: [{% for r in reports[:200] %}{{ r.Performance_Score }},{% endfor %}],
        backgroundColor: ["#007bff","#28a745","#dc3545","#ffc107","#17a2b8"]
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true, position: "bottom" } }
    }
  });
}

document.getElementById("dataView").addEventListener("change", function() {
  renderChart(this.value);
});

// Load More button logic
if (loadBtn) {
  loadBtn.addEventListener("click", async () => {
    const res = await fetch(`/reports_data?offset=${offset}`);
    const rows = await res.text();
    document.getElementById("reportTableBody").insertAdjacentHTML("beforeend", rows);
    offset += 200;
    if (offset >= totalReports) {
      loadBtn.style.display = "none";
    }
  });
}
</script>

{% endblock %}
